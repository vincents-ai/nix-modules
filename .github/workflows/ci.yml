name: CI

on:
  push:
    branches:
      - main
      - master
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Setup cachix
        uses: cachix/cachix-action@v15
        with:
          name: vincents-ai
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Check flake
        run: nix flake check

      - name: Check formatting
        run: nix fmt -- --check .

      - name: Check module imports
        run: nix build .#checks.x86_64-linux.module-check

  format-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Install nixfmt
        run: nix profile install nixpkgs#nixfmt

      - name: Check nix formatting
        run: |
          find . -name "*.nix" -type f | while read -r file; do
            if ! nixfmt --check "$file" 2>/dev/null; then
              echo "Error: $file is not formatted"
              nixfmt "$file" | diff - "$file" || true
              exit 1
            fi
          done

  statix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Install statix
        run: nix profile install nixpkgs#statix

      - name: Run statix linter
        run: |
          if command -v statix &>/dev/null; then
            statix check .
          else
            echo "Statix not available, skipping"
          fi

  bdd-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Setup cachix
        uses: cachix/cachix-action@v15
        with:
          name: vincents-ai
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Build BDD tests (x86_64-linux)
        run: nix build .#checks.x86_64-linux.bdd-vm-test

      - name: Run BDD tests
        run: ./result/bin/bdd-vm-test

  build-all:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch:
          - x86_64-linux
          - aarch64-linux
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Setup cachix
        uses: cachix/cachix-action@v15
        with:
          name: vincents-ai
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Build all modules (${{ matrix.arch }})
        run: nix build .#checks.${{ matrix.arch }}.all-modules
